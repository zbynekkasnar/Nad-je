<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KANCEL√Å≈ò NADƒöJE v2.5</title>
    
    <script src="stats.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --neon: #00f2ff; 
            --dark: #0f172a; 
            --card-bg: rgba(255, 255, 255, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body { 
            background: var(--dark); 
            color: white; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 15px; 
            text-align: center; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-x: hidden; 
        }

        /* FIXN√ç ADMIN TLAƒå√çTKO - V≈ΩDY NAHO≈òE VPRAVO */
        .admin-lock {
            position: fixed; 
            top: 20px; 
            right: 20px;
            width: 48px; 
            height: 48px;
            background: rgba(15, 23, 42, 0.85);
            border: 2px solid var(--neon);
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            text-decoration: none; 
            font-size: 1.3em;
            z-index: 9999; 
            transition: var(--transition);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            backdrop-filter: blur(8px);
        }
        .admin-lock:hover { 
            background: var(--neon); 
            transform: rotate(20deg) scale(1.1); 
            box-shadow: 0 0 30px var(--neon); 
        }

        /* ANIMOVAN√â LOGO - PULZOV√ÅN√ç */
        .header-logo { 
            max-width: 450px; 
            width: 90%; 
            margin: 20px 0 35px 0;
            filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.5)); 
            animation: neonPulse 3s ease-in-out infinite alternate; 
        }

        @keyframes neonPulse {
            from { filter: drop-shadow(0 0 8px rgba(0, 242, 255, 0.4)); transform: scale(1); }
            to { filter: drop-shadow(0 0 20px rgba(0, 242, 255, 0.8)); transform: scale(1.02); }
        }

        /* BANK BOX */
        .bank-box { 
            background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,242,255,0.1)); 
            border: 1px solid var(--neon); 
            border-radius: 20px; 
            padding: 25px; 
            min-width: 280px; 
            margin-bottom: 35px; 
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.15); 
        }
        .bank-box span { font-size: 2.8em; font-weight: 900; text-shadow: 0 0 15px var(--neon); }
        .bank-label { display: block; opacity: 0.5; font-size: 0.7em; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }

        .btn-stats { 
            display: inline-block; 
            margin-bottom: 30px; 
            padding: 12px 28px; 
            background: rgba(0, 242, 255, 0.05); 
            border: 1px solid var(--neon); 
            color: var(--neon); 
            text-decoration: none; 
            border-radius: 50px; 
            font-weight: bold; 
            transition: var(--transition); 
        }
        .btn-stats:hover { background: var(--neon); color: black; box-shadow: 0 0 25px var(--neon); }

        /* Z√ÅPASY - KARTY */
        #matchList { width: 100%; max-width: 600px; }

        .match-card { 
            background: var(--card-bg); 
            border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.1); 
            margin-bottom: 25px; 
            padding: 25px; 
            cursor: pointer; 
            transition: var(--transition); 
            position: relative; 
        }
        .match-card:hover { border-color: var(--neon); background: rgba(255,255,255,0.08); }

        /* BAROMETR ROZLO≈ΩEN√ç TIP≈Æ */
        .barometer-container { 
            width: 100%; 
            height: 8px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
            margin: 20px 0 8px 0; 
            display: flex; 
            overflow: hidden; 
        }
        .bar-1 { height: 100%; background: #38a169; transition: 0.6s ease-out; } /* V√Ωhra dom√°c√≠ch */
        .bar-0 { height: 100%; background: #718096; transition: 0.6s ease-out; } /* Rem√≠za */
        .bar-2 { height: 100%; background: #3182ce; transition: 0.6s ease-out; } /* V√Ωhra host≈Ø */
        
        .barometer-labels { 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.65em; 
            opacity: 0.6; 
            font-weight: bold; 
            margin-bottom: 15px; 
            letter-spacing: 1px;
        }

        /* 3D VLAJKY */
        .flags-wrapper { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 10px; 
            margin: 10px 0; 
        }
        .flag-container { perspective: 1000px; text-align: center; width: 100px; }
        .flag-img { 
            width: 85px; 
            border-radius: 6px; 
            animation: flagWave 4s ease-in-out infinite; 
            transform-origin: left center; 
            border-left: 2px solid rgba(255,255,255,0.4); 
            box-shadow: 0 12px 25px rgba(0,0,0,0.5); 
        }
        @keyframes flagWave { 
            0%, 100% { transform: rotateY(0deg); } 
            50% { transform: rotateY(20deg) rotateX(5deg); } 
        }
        .vs { 
            background: var(--neon); 
            color: black; 
            border-radius: 50%; 
            width: 38px; 
            height: 38px; 
            line-height: 38px; 
            font-weight: 900; 
        }

        .timer-box { 
            font-size: 0.85em; 
            font-weight: 800; 
            color: var(--neon); 
            background: rgba(0,0,0,0.5); 
            padding: 8px 18px; 
            border-radius: 50px; 
            border: 1px solid rgba(0,242,255,0.2); 
        }

        /* FORMUL√Å≈ò S√ÅZEK */
        .details { 
            display: none; 
            padding-top: 25px; 
            border-top: 1px solid rgba(255,255,255,0.1); 
            margin-top: 20px; 
            text-align: left; 
        }
        .name-input { 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 20px; 
            background: rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.2); 
            color: white; 
            border-radius: 12px; 
            box-sizing: border-box; 
        }
        .score-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 20px; 
            margin: 15px 0; 
        }
        .score-input { 
            width: 75px; 
            height: 60px; 
            text-align: center; 
            font-weight: 900; 
            font-size: 1.8em; 
            background: #000; 
            border: 2px solid #334155; 
            color: white; 
            border-radius: 15px; 
        }

        .btn-add { 
            width: 100%; 
            background: var(--neon); 
            color: black; 
            border: none; 
            padding: 18px; 
            border-radius: 15px; 
            font-weight: 900; 
            cursor: pointer; 
            text-transform: uppercase; 
        }
        
        /* SEZNAM TIP≈Æ S TERƒå√çKEM */
        .bet-row { 
            padding: 14px; 
            border-radius: 15px; 
            margin-bottom: 10px; 
            border-left: 4px solid var(--neon); 
            display: flex; 
            flex-direction: column; 
            font-size: 0.9em; 
        }
        .bet-main { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .bet-player { font-size: 0.9em; color: var(--neon); opacity: 0.8; margin-top: 4px; }

        /* KO≈†√çK / TIKET */
        #cart { 
            position: fixed; 
            bottom: 25px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 92%; 
            max-width: 480px; 
            background: #1e293b; 
            border: 2px solid var(--neon); 
            border-radius: 30px; 
            padding: 30px; 
            display: none; 
            z-index: 2000; 
            box-shadow: 0 0 60px rgba(0,0,0,0.9); 
        }
    </style>
</head>
<body>

    <a href="admin.html" class="admin-lock">‚öôÔ∏è</a>

    <img src="IMG_8427.jpeg" alt="KANCEL√Å≈ò NADƒöJE" class="header-logo">

    <div class="bank-box">
        <span class="bank-label">Aktu√°ln√≠ bank v h≈ôe</span>
        <span id="mainBank">0</span> Kƒç
    </div>

    <a href="statistiky.html" class="btn-stats">üìä ≈ΩEB≈ò√çƒåKY A STATISTIKY</a>

    <div id="matchList"></div>

    <div id="cart">
        <span style="position:absolute; top:20px; right:25px; font-size:2em; cursor:pointer;" onclick="closeCart()">√ó</span>
        <div id="cartContent">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left;">
                    <b id="cartCount">0 z√°pas≈Ø</b><br>
                    <span id="cartTotal" style="color:var(--neon); font-size:1.8em; font-weight:900;">0 Kƒç</span>
                </div>
                <button id="sendBtn" class="btn-add" style="width:auto; padding: 12px 30px;" onclick="odeslatTiket()">ODESLAT TIKET</button>
            </div>
        </div>
        <div id="qrArea" style="display:none; text-align:center; margin-top:15px;">
            <div id="qrStatus" style="font-weight:900; color:var(--neon); margin-bottom:15px;">‚úÖ ODESL√ÅNO!</div>
            <img id="qrImg" src="" style="width:200px; background:white; padding:10px; border-radius:15px;">
            <p id="qrDesc" style="font-size:0.85em; margin-top:15px; opacity:0.7;"></p>
        </div>
    </div>

<script>
    // Konfigurace Firebase
    const firebaseConfig = { 
        apiKey: "AIzaSyC-NCdmsgA42FxnopKm92m1y5gUGw_z_uE", 
        authDomain: "nadeje-208bd.firebaseapp.com", 
        databaseURL: "https://nadeje-208bd-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "nadeje-208bd", 
        storageBucket: "nadeje-208bd.firebasestorage.app", 
        messagingSenderId: "688478977789", 
        appId: "1:688478977789:web:512d1520cf96c9e59cc894" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let kosik = {}; 
    let activeTimers = {};

    // Hlavn√≠ vykreslovac√≠ funkce
    db.ref('sazkyData').on('value', snap => {
        const data = snap.val() || {};
        const list = document.getElementById('matchList');
        list.innerHTML = "";
        
        if (!data.zapasy) { 
            document.getElementById('mainBank').innerText = data.prevedenyBank || 0; 
            return; 
        }

        const zapasy = Object.entries(data.zapasy).map(([id, m]) => ({id, ...m})).sort((a,b) => new Date(a.deadline) - new Date(b.deadline));
        
        // V√Ωpoƒçet banku pro nejbli≈æ≈°√≠ z√°pas
        const prvniZapas = zapasy[0];
        const vklady = prvniZapas.sazky ? Object.keys(prvniZapas.sazky).length * 20 : 0;
        document.getElementById('mainBank').innerText = parseInt(data.prevedenyBank || 0) + vklady;

        zapasy.forEach(m => {
            const id = m.id;
            activeTimers[id] = m.deadline;
            const isClosed = Date.now() > new Date(m.deadline).getTime();
            const isEvaluated = m.status === "vyhodnoceno";

            // V√ùPOƒåET PRO BAROMETR
            let domaci = 0, remiza = 0, hoste = 0, celkem = 0;
            if(m.sazky) {
                Object.values(m.sazky).forEach(s => {
                    const sk = s.skore.split(':');
                    const d = parseInt(sk[0]), h = parseInt(sk[1]);
                    if(d > h) domaci++;
                    else if(d === h) remiza++;
                    else hoste++;
                    celkem++;
                });
            }
            const pDomaci = celkem ? (domaci / celkem) * 100 : 33.3;
            const pRemiza = celkem ? (remiza / celkem) * 100 : 33.3;
            const pHoste = celkem ? (hoste / celkem) * 100 : 33.3;

            const card = document.createElement('div');
            card.className = "match-card";
            card.onclick = () => toggle(id);

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div style="color:var(--neon); font-size:0.75em; font-weight:900;">VKLADY: ${celkem * 20} Kƒç</div>
                    ${isEvaluated ? `<div class="timer-box" style="background:#27ae60; border:none;">‚úÖ HOTOVO (${m.vysledek})</div>` : `<div id="t-${id}" class="timer-box">--:--:--</div>`}
                </div>
                <div class="flags-wrapper">
                    <div class="flag-container"><img class="flag-img" src="https://flagcdn.com/w160/${m.kodD}.png"><br><small>${m.domaci}</small></div>
                    <div class="vs">VS</div>
                    <div class="flag-container"><img class="flag-img" src="https://flagcdn.com/w160/${m.kodH}.png"><br><small>${m.hoste}</small></div>
                </div>
                
                <div class="barometer-container">
                    <div class="bar-1" style="width:${pDomaci}%"></div>
                    <div class="bar-0" style="width:${pRemiza}%"></div>
                    <div class="bar-2" style="width:${pHoste}%"></div>
                </div>
                <div class="barometer-labels">
                    <span>DOM√ÅC√ç ${Math.round(pDomaci)}%</span>
                    <span>REMIZA ${Math.round(pRemiza)}%</span>
                    <span>HOST√â ${Math.round(pHoste)}%</span>
                </div>

                <div id="det-${id}" class="details" onclick="event.stopPropagation()">
                    ${(!isClosed && !isEvaluated) ? `
                        <input type="text" id="name-${id}" class="name-input" placeholder="Tv√© jm√©no">
                        <div class="score-container">
                            <input type="number" id="sD-${id}" class="score-input">
                            <span style="font-weight:900; color:var(--neon); font-size:1.5em;">:</span>
                            <input type="number" id="sH-${id}" class="score-input">
                        </div>
                        <input type="text" id="p-${id}" class="name-input" placeholder="St≈ôelec g√≥lu">
                        <button class="btn-add" onclick="pridat('${id}')">P≈òIDAT NA TIKET (20 Kƒç)</button>
                    ` : `<div style="text-align:center; color:var(--neon); font-weight:bold; margin-bottom:15px;">S√°zky pro tento z√°pas jsou uzav≈ôeny</div>`}
                    
                    <div id="bets-${id}" style="margin-top:20px;"></div>
                </div>`;
            list.appendChild(card);

            // Vykreslen√≠ jednotliv√Ωch s√°zek
            if(m.sazky) {
                const cSkore = {}, cFull = {};
                Object.values(m.sazky).forEach(s => { 
                    const f = `${s.skore}-${s.strelec.toLowerCase().trim()}`; 
                    cSkore[s.skore] = (cSkore[s.skore] || 0) + 1; 
                    cFull[f] = (cFull[f] || 0) + 1; 
                });

                Object.values(m.sazky).forEach(s => {
                    const fK = `${s.skore}-${s.strelec.toLowerCase().trim()}`;
                    const showAll = isClosed || isEvaluated;
                    let rowBg = "rgba(255,255,255,0.03)";
                    
                    if(cFull[fK] > 1) rowBg = "rgba(255, 165, 0, 0.2)"; // Duplicita sk√≥re i st≈ôelce
                    else if(cSkore[s.skore] > 1) rowBg = "rgba(255, 255, 0, 0.1)"; // Duplicita pouze sk√≥re

                    document.getElementById(`bets-${id}`).innerHTML += `
                        <div class="bet-row" style="background:${rowBg}">
                            <div class="bet-main">
                                <span>${s.stav || "‚è≥"} ${s.jmeno}</span>
                                <span style="color:var(--neon)">${(s.skryt && !showAll) ? '??:??' : s.skore}</span>
                            </div>
                            <div class="bet-player">üéØ ${(s.skryt && !showAll) ? '*******' : (s.strelec || '---')}</div>
                        </div>`;
                });
            }
        });
    });

    function toggle(id) { 
        const el = document.getElementById(`det-${id}`); 
        el.style.display = (el.style.display === 'block') ? 'none' : 'block'; 
    }

    function closeCart() { document.getElementById('cart').style.display = 'none'; }

    function pridat(id) {
        const jm = document.getElementById(`name-${id}`).value;
        const sD = document.getElementById(`sD-${id}`).value;
        const sH = document.getElementById(`sH-${id}`).value;
        const p = document.getElementById(`p-${id}`).value;

        if(!jm || sD === "" || sH === "" || !p) return alert("Vypl≈à v≈°echna pole!");

        db.ref(`sazkyData/zapasy/${id}/sazky`).once('value', snap => {
            const existujici = snap.val() || {};
            const jeObsazeno = Object.values(existujici).some(s => 
                s.skore === `${sD}:${sH}` && s.strelec.toLowerCase().trim() === p.toLowerCase().trim()
            );
            
            if(jeObsazeno) return alert("Tato kombinace sk√≥re a st≈ôelce je ji≈æ obsazena!");

            kosik[id] = { jmeno: jm, skore: `${sD}:${sH}`, strelec: p };
            document.getElementById('cartCount').innerText = `${Object.keys(kosik).length} z√°pas≈Ø na tiketu`;
            document.getElementById('cartTotal').innerText = `${Object.keys(kosik).length * 20} Kƒç`;
            document.getElementById('cart').style.display = 'block'; 
            toggle(id);
        });
    }

    function odeslatTiket() {
        const btn = document.getElementById('sendBtn');
        btn.disabled = true;
        let jmenoHrace = "";
        
        Object.entries(kosik).forEach(([mid, d]) => { 
            db.ref(`sazkyData/zapasy/${mid}/sazky`).push({ ...d, stav: "‚è≥" }); 
            jmenoHrace = d.jmeno; 
        });

        const suma = Object.keys(kosik).length * 20;
        const zprava = `Sazka_${jmenoHrace}`.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        
        document.getElementById('cartContent').style.display = 'none';
        document.getElementById('qrImg').src = `https://api.paylibo.com/paylibo/generator/czech/image?accountNumber=295511827&bankCode=0300&amount=${suma}&currency=CZK&message=${zprava}`;
        document.getElementById('qrDesc').innerHTML = `ƒå√°stka: <b>${suma} Kƒç</b><br>Zpr√°va: <b>${zprava}</b>`;
        document.getElementById('qrArea').style.display = 'block'; 
        kosik = {};
    }

    // Odpoƒçet ƒçasu
    setInterval(() => {
        const now = Date.now();
        Object.entries(activeTimers).forEach(([id, deadline]) => {
            const el = document.getElementById(`t-${id}`); 
            if(!el) return;
            const diff = new Date(deadline).getTime() - now;
            if(diff <= 0) { 
                el.innerText = "üîê ZAV≈òENO"; 
                el.style.color = "#ff4444"; 
            } else { 
                const h = Math.floor(diff/3600000);
                const m = Math.floor((diff%3600000)/60000);
                const s = Math.floor((diff%60000)/1000);
                el.innerText = `‚è±Ô∏è ${h}h ${m}m ${s}s`; 
            }
        });
    }, 1000);
</script>
</body>
</html>
