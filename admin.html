<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin v3.1 - KANCEL√Å≈ò NADƒöJE</title>
    
    <script src="stats.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --blue: #3182ce; 
            --green: #38a169; 
            --red: #e53e3e; 
            --bg: #f0f4f8; 
            --text: #2d3748;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); padding: 20px; color: var(--text); margin: 0; 
        }

        .container { max-width: 900px; margin: 0 auto; }
        
        .btn-back { 
            display: inline-block; padding: 12px 24px; background: white; 
            color: #4a5568; text-decoration: none; border-radius: 12px; 
            font-weight: bold; border: 1px solid #cbd5e0; margin-bottom: 25px; 
            transition: 0.3s;
        }
        .btn-back:hover { background: #edf2f7; transform: translateX(-3px); }

        .card { 
            background: white; padding: 30px; border-radius: 20px; 
            margin-bottom: 30px; box-shadow: var(--card-shadow); 
            border: 1px solid #e2e8f0; 
        }

        h2 { margin: 0 0 20px 0; border-bottom: 2px solid #edf2f7; padding-bottom: 12px; font-size: 1.5em; }
        h3 { color: #4a5568; margin-top: 0; }

        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.85em; color: #718096; text-transform: uppercase; }
        input, textarea { 
            width: 100%; padding: 14px; margin: 8px 0; 
            border: 1px solid #cbd5e0; border-radius: 10px; 
            box-sizing: border-box; font-size: 1em; font-family: inherit;
        }

        .btn { 
            padding: 15px; border: none; border-radius: 12px; color: white; 
            cursor: pointer; width: 100%; font-weight: bold; 
            text-transform: uppercase; margin-top: 10px; transition: 0.3s; 
        }
        .btn-blue { background: var(--blue); }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        .match-item { 
            background: #f8fafc; border: 1px solid #e2e8f0; 
            padding: 25px; border-radius: 18px; margin-top: 25px; 
            position: relative;
        }
        
        .bets-container { display: none; margin-top: 20px; border-top: 2px dashed #edf2f7; padding-top: 15px; }
        
        .bet-admin-row { 
            background: white; padding: 12px 18px; border-radius: 12px; 
            margin-top: 10px; border: 1px solid #edf2f7; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        
        .small-btn { 
            padding: 8px 14px; border-radius: 8px; font-size: 0.75em; 
            border: none; color: white; cursor: pointer; font-weight: bold; margin-left: 6px; 
        }

        .check-ok { color: var(--green); font-weight: bold; font-size: 0.8em; margin-left: 10px; }
        .check-fail { color: var(--red); font-weight: bold; font-size: 0.8em; margin-left: 10px; }

        .history-section { border-top: 5px solid #cbd5e0; margin-top: 60px; padding-top: 30px; }

        /* MODAL */
        #evalModal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 90%; max-width: 550px; background: white; border-radius: 25px; 
            box-shadow: 0 0 80px rgba(0,0,0,0.6); display: none; z-index: 3000; padding: 35px; 
        }
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; z-index: 2999; 
        }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 20px 0; background: #f1f5f9; padding: 10px; border-radius: 12px; }
        .tag { background: white; padding: 6px 12px; border-radius: 15px; font-size: 0.85em; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 8px; }
        .tag b { cursor: pointer; color: var(--red); }
    </style>
</head>
<body onload="initAdmin()">

<div class="container">
    <a href="index.html" class="btn-back">‚Üê ZPƒöT NA WEB</a>
    <h1 style="text-align: center;">‚öôÔ∏è Administrace v3.1</h1>

    <div class="card">
        <h2>üí∞ Spr√°va banku</h2>
        <label>Z≈Østatek z minul√Ωch kol (Kƒç):</label>
        <input type="number" id="prevBankInput" placeholder="Zadej ƒç√°stku">
        <button class="btn btn-blue" onclick="saveBank()">Aktualizovat a ulo≈æit bank</button>
    </div>

    <div class="card">
        <h2>üöÄ Vypsat nov√Ω z√°pas</h2>
        <div style="display:flex; gap:15px;">
            <div style="flex:1;">
                <label>Dom√°c√≠ t√Ωm:</label>
                <input list="statyList" id="d" placeholder="Nap≈ô. ƒåesko">
            </div>
            <div style="flex:1;">
                <label>Hostuj√≠c√≠ t√Ωm:</label>
                <input list="statyList" id="h" placeholder="Nap≈ô. Kanada">
            </div>
        </div>
        <label>Uz√°vƒõrka s√°zek (Deadline):</label>
        <input type="datetime-local" id="dl">
        <button class="btn btn-green" onclick="addM()">Uve≈ôejnit z√°pas na webu</button>
    </div>

    <div class="card">
        <h2>üìä Aktivn√≠ z√°pasy</h2>
        <div id="activeMatches">Naƒç√≠t√°m z√°pasy...</div>
    </div>

    <div class="history-section">
        <h2>üìú Historie a vyhodnocen√© z√°pasy</h2>
        <div id="historyMatches">Zat√≠m ≈æ√°dn√° historie.</div>
    </div>
</div>

<div id="modalOverlay" class="modal-overlay"></div>
<div id="evalModal">
    <h3 style="text-align:center">üõ†Ô∏è Vyhodnocen√≠ z√°pasu</h3>
    <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin: 30px 0;">
        <input type="number" id="finalD" style="width:80px; text-align:center; font-size:2em; font-weight:bold; border:2px solid var(--blue); border-radius:10px;">
        <span style="font-size:2em; font-weight:bold;">:</span>
        <input type="number" id="finalH" style="width:80px; text-align:center; font-size:2em; font-weight:bold; border:2px solid var(--blue); border-radius:10px;">
    </div>
    <label>St≈ôelci v z√°kladn√≠ hrac√≠ dobƒõ:</label>
    <div id="finalStrelci" class="tag-container"></div>
    <div style="display:flex; gap:10px; margin-bottom:25px;">
        <input type="text" id="addStrelecInput" placeholder="P≈ôidat st≈ôelce ruƒçnƒõ..." style="margin:0;">
        <button class="btn btn-blue" style="width:auto; margin:0; padding:0 20px;" onclick="manualAddStrelec()">+</button>
    </div>
    <div style="display:flex; gap:15px;">
        <button class="btn btn-red" onclick="closeEvalModal()">ZRU≈†IT</button>
        <button class="btn btn-green" id="confirmEvalBtn">VYPLATIT A P≈òESUNOUT</button>
    </div>
</div>

<datalist id="statyList"></datalist>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyC-NCdmsgA42FxnopKm92m1y5gUGw_z_uE", 
        authDomain: "nadeje-208bd.firebaseapp.com", 
        databaseURL: "https://nadeje-208bd-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "nadeje-208bd", 
        storageBucket: "nadeje-208bd.firebasestorage.app", 
        messagingSenderId: "688478977789", 
        appId: "1:688478977789:web:512d1520cf96c9e59cc894" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentStrelci = [];
    let openMatches = {}; // Pamatuje si rozbalen√° okna s√°zek

    function checkAuth() {
        if (!sessionStorage.getItem('adminTime') || (Date.now() - sessionStorage.getItem('adminTime') > 300000)) {
            const pass = prompt("Zadej administr√°torsk√© heslo:");
            if (pass === "heslo123") {
                sessionStorage.setItem('adminTime', Date.now());
            } else {
                alert("Nespr√°vn√© heslo!");
                window.location.href = "index.html";
            }
        } else {
            sessionStorage.setItem('adminTime', Date.now());
        }
    }

    function initAdmin() {
        checkAuth();
        const dl = document.getElementById('statyList');
        if (typeof vsechnyStaty !== 'undefined') {
            vsechnyStaty.forEach(s => {
                const o = document.createElement('option');
                o.value = s.n;
                dl.appendChild(o);
            });
        }
        db.ref('sazkyData/prevedenyBank').on('value', snap => {
            document.getElementById('prevBankInput').value = snap.val() || 0;
        });
    }

    function saveBank() {
        checkAuth();
        const val = parseInt(document.getElementById('prevBankInput').value) || 0;
        db.ref('sazkyData/prevedenyBank').set(val).then(() => alert("Bank √∫spƒõ≈°nƒõ ulo≈æen!"));
    }

    function addM() {
        checkAuth();
        const d = document.getElementById('d').value, h = document.getElementById('h').value, dl = document.getElementById('dl').value;
        if(!d || !h || !dl) return alert("Mus√≠≈° vyplnit v≈°echny √∫daje!");
        
        const kd = vsechnyStaty.find(s => s.n === d)?.c || "un";
        const kh = vsechnyStaty.find(s => s.n === h)?.c || "un";
        
        db.ref('sazkyData/zapasy').push({ 
            domaci: d, hoste: h, kodD: kd, kodH: kh, deadline: dl, status: "aktivni" 
        }).then(() => {
            alert("Z√°pas byl publikov√°n!");
            document.getElementById('d').value = ""; document.getElementById('h').value = "";
        });
    }

    db.ref('sazkyData/zapasy').on('value', snap => {
        const activeCont = document.getElementById('activeMatches');
        const historyCont = document.getElementById('historyMatches');
        activeCont.innerHTML = ""; historyCont.innerHTML = "";
        
        const data = snap.val(); if(!data) return activeCont.innerHTML = "≈Ω√°dn√© aktivn√≠ z√°pasy.";

        Object.entries(data).forEach(([mid, m]) => {
            const div = document.createElement('div');
            div.className = 'match-item';
            
            // Logika zachov√°n√≠ rozbalen√≠ okna
            const isVisible = openMatches[mid] ? "block" : "none";
            const btnText = openMatches[mid] ? "SKR√ùT S√ÅZKY" : `üëÅÔ∏è ZOBRAZIT S√ÅZKY (${m.sazky ? Object.keys(m.sazky).length : 0})`;

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <strong style="font-size:1.2em;">${m.domaci} - ${m.hoste}</strong>
                    ${m.vysledek ? `<span style="background:var(--green); color:white; padding:5px 12px; border-radius:10px; font-weight:bold;">${m.vysledek}</span>` : ''}
                </div>
                <textarea id="raw-${mid}" placeholder="Vlo≈æ text z p≈ôehledu Livesport / Sport.cz..."></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-blue" style="flex:2" onclick="evalM('${mid}')">${m.status === 'vyhodnoceno' ? 'P≈òE-VYHODNOTIT' : 'VYHODNOTIT Z√ÅPAS'}</button>
                    <button class="btn btn-red" style="flex:1" onclick="deleteM('${mid}')">SMAZAT</button>
                </div>
                <button class="btn" style="background:#edf2f7; color:#4a5568; margin-top:12px;" onclick="toggleBets('${mid}')" id="btn-${mid}">${btnText}</button>
                <div id="bets-${mid}" class="bets-container" style="display:${isVisible}"></div>
            `;
            
            if(m.status === "vyhodnoceno") historyCont.appendChild(div);
            else activeCont.appendChild(div);

            // V√Ωpis s√°zek v adminu s kontrolou trefen√≠
            if(m.sazky) {
                Object.entries(m.sazky).forEach(([sid, s]) => {
                    let evaluationResult = "";
                    if(m.status === "vyhodnoceno") {
                        const scoreIsOk = s.skore.replace(/\s/g,'') === m.vysledek.replace(/\s/g,'');
                        evaluationResult = scoreIsOk ? `<span class="check-ok">‚úÖ TREFENO</span>` : `<span class="check-fail">‚ùå</span>`;
                    }
                    
                    const row = document.createElement('div');
                    row.className = 'bet-admin-row';
                    row.innerHTML = `
                        <span>${s.stav || "‚è≥"} <b>${s.jmeno}</b> (${s.skore} - ${s.strelec}) ${evaluationResult}</span>
                        <div>
                            <button class="small-btn btn-green" onclick="markPaid('${mid}','${sid}')">Kƒå</button>
                            <button class="small-btn btn-red" onclick="deleteBet('${mid}','${sid}')">√ó</button>
                        </div>`;
                    document.getElementById(`bets-${mid}`).appendChild(row);
                });
            }
        });
    });

    function toggleBets(mid) {
        const c = document.getElementById(`bets-${mid}`);
        const b = document.getElementById(`btn-${mid}`);
        openMatches[mid] = (c.style.display === "none");
        c.style.display = openMatches[mid] ? "block" : "none";
        b.innerText = openMatches[mid] ? "SKR√ùT S√ÅZKY" : b.innerText.replace("SKR√ùT", "üëÅÔ∏è");
    }

    function evalM(mid) {
        checkAuth();
        const raw = document.getElementById(`raw-${mid}`).value;
        if(!raw) return alert("Vlo≈æte text z p≈ôehledu z√°pasu!");

        let cleanText = raw.split(/PRODLOU≈ΩEN√ç|PENALTY|N√ÅJEZDY|OVERTIME/i)[0];
        
        // Extrakce sk√≥re
        const scoreMatches = cleanText.match(/(\d+)\s*[:|-]\s*(\d+)/g);
        let d = 0, h = 0;
        if (scoreMatches) {
            const last = scoreMatches[scoreMatches.length - 1].replace(/\s+/g, '').replace('-', ':').split(':');
            d = last[0]; h = last[1];
        }

        // Extrakce st≈ôelc≈Ø s filtrem zak√°zan√Ωch slov (Livesport bugfix)
        currentStrelci = [];
        const filterWords = ["t≈ôetina", "poloƒças", "konec", "p≈ôest√°vka", "vylouƒçen√≠", "minuta", "karta", "st≈ô√≠d√°n√≠", "rozhodƒç√≠", "g√≥ly", "st≈ôely"];
        
        cleanText.split('\n').forEach(line => {
            const t = line.trim();
            if (t.match(/^[\d+]+['.]/)) {
                let name = t.replace(/^[\d+]+['.]\s*/, '').split('(')[0].split(',')[0].replace(/[0-9]/g, '').replace(/[:|-]/g, '').trim();
                if (name.length > 3 && !filterWords.some(w => name.toLowerCase().includes(w)) && !currentStrelci.includes(name)) {
                    currentStrelci.push(name);
                }
            }
        });

        document.getElementById('finalD').value = d;
        document.getElementById('finalH').value = h;
        renderTags();
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('evalModal').style.display = 'block';
        document.getElementById('confirmEvalBtn').onclick = () => finishEval(mid);
    }

    function renderTags() {
        const c = document.getElementById('finalStrelci'); c.innerHTML = "";
        currentStrelci.forEach((s, i) => {
            c.innerHTML += `<div class="tag">${s} <b onclick="currentStrelci.splice(${i},1);renderTags()">√ó</b></div>`;
        });
    }

    function manualAddStrelec() {
        const val = document.getElementById('addStrelecInput').value;
        if(val) { currentStrelci.push(val); renderTags(); document.getElementById('addStrelecInput').value = ""; }
    }

    function closeEvalModal() {
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('evalModal').style.display = 'none';
    }

    function markPaid(mid, sid) { db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("‚úÖ"); }
    function deleteBet(mid, sid) { if(confirm("Smazat s√°zku?")) db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}`).remove(); }
    function deleteM(mid) { if(confirm("Opravdu smazat cel√Ω z√°pas?")) db.ref(`sazkyData/zapasy/${mid}`).remove(); }

    function finishEval(mid) {
        const fScore = `${document.getElementById('finalD').value}:${document.getElementById('finalH').value}`;
        const fStrelciLower = currentStrelci.map(s => s.toLowerCase());
        
        db.ref(`sazkyData/zapasy/${mid}`).once('value', snap => {
            const z = snap.val(); 
            const sazky = Object.entries(z.sazky || {});
            
            // Resetov√°n√≠ v≈°ech s√°zek u tohoto z√°pasu p≈ôed nov√Ωm v√Ωpoƒçtem
            sazky.forEach(([sid, s]) => {
                db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("‚ùå");
            });

            // Filtrace v√≠tƒõz≈Ø
            let winS = sazky.filter(([sid, s]) => s.skore.replace(/\s/g,'') === fScore);
            let winB = winS.filter(([sid, s]) => fStrelciLower.some(r => r.includes(s.strelec.toLowerCase().trim()) || s.strelec.toLowerCase().trim().includes(r)));
            
            let vyherci = winB.length > 0 ? winB : winS;
            
            db.ref('sazkyData/prevedenyBank').once('value', bSnap => {
                const totalBank = (sazky.length * 20) + (bSnap.val() || 0);
                
                if(vyherci.length > 0) {
                    const podil = Math.floor(totalBank / vyherci.length);
                    vyherci.forEach(([sid, s]) => {
                        db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("üèÜ");
                        db.ref(`sazkyData/stats/${s.jmeno}`).transaction(c => {
                            c = c || { vyhry: 0, trefeneSkore: 0, trefeniStrelci: 0 };
                            c.vyhry += podil;
                            c.trefeneSkore += 1;
                            if(winB.length > 0) c.trefeniStrelci += 1;
                            return c;
                        });
                    });
                    db.ref('sazkyData/prevedenyBank').set(0);
                } else {
                    db.ref('sazkyData/prevedenyBank').set(totalBank);
                }
                
                db.ref(`sazkyData/zapasy/${mid}/status`).set("vyhodnoceno");
                db.ref(`sazkyData/zapasy/${mid}/vysledek`).set(fScore);
                closeEvalModal();
                alert("Z√°pas byl vyhodnocen a p≈ôesunut do historie.");
            });
        });
    }
</script>
</body>
</html>
