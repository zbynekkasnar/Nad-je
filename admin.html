<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - KANCEL√Å≈ò NADƒöJE</title>
    <script src="stats.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --blue: #3182ce; 
            --green: #38a169; 
            --red: #e53e3e; 
            --bg: #f0f4f8; 
        }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            padding: 20px; 
            color: #1a202c; 
            margin: 0; 
        }

        .container { max-width: 800px; margin: 0 auto; }
        
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            border: 1px solid #e2e8f0; 
        }

        h2 { 
            margin: 0 0 20px 0; 
            color: #2d3748; 
            font-size: 1.5em; 
            border-bottom: 2px solid #edf2f7; 
            padding-bottom: 10px; 
        }

        label { 
            display: block; 
            margin-top: 15px; 
            font-weight: bold; 
            font-size: 0.85em; 
            color: #4a5568; 
            text-transform: uppercase; 
        }

        input, textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border: 1px solid #cbd5e0; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 1em; 
        }

        textarea { height: 80px; font-family: monospace; font-size: 0.8em; }

        .btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            color: white; 
            cursor: pointer; 
            font-weight: bold; 
            text-transform: uppercase; 
            transition: 0.2s; 
            display: inline-block; 
            text-align: center; 
            width: 100%;
            margin-top: 10px;
        }
        .btn-blue { background: var(--blue); }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .btn:hover { filter: brightness(90%); }

        /* Z√ÅPASY A S√ÅZKY */
        .match-item { 
            background: #f8fafc; 
            border: 1px solid #e2e8f0; 
            padding: 20px; 
            border-radius: 12px; 
            margin-top: 20px; 
        }
        .bet-admin-row { 
            background: white; 
            padding: 10px 15px; 
            border-radius: 8px; 
            margin-top: 8px; 
            border: 1px solid #edf2f7; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .small-btn { 
            padding: 6px 12px; 
            border-radius: 6px; 
            font-size: 0.75em; 
            border: none; 
            cursor: pointer; 
            color: white; 
            font-weight: bold; 
            margin-left: 5px; 
        }

        /* MOD√ÅL PRO VYHODNOCEN√ç */
        #evalModal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 90%; max-width: 500px; background: white; border-radius: 20px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); display: none; z-index: 2000; padding: 25px; 
        }
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); display: none; z-index: 1999; 
        }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { 
            background: #edf2f7; padding: 5px 12px; border-radius: 15px; 
            font-size: 0.85em; display: flex; align-items: center; gap: 8px; 
        }
        .tag span { cursor: pointer; color: var(--red); font-weight: bold; }
    </style>
</head>
<body onload="initAdmin()">

<div class="container">
    <h1 style="text-align: center; color: #2d3748;">‚öôÔ∏è Administrace Nadƒõje</h1>

    <div class="card">
        <h2>üí∞ P≈ôeveden√Ω Bank</h2>
        <input type="number" id="prevBankInput" placeholder="0">
        <button class="btn btn-blue" onclick="saveBank()">Aktualizovat P≈ôeveden√Ω Bank</button>
    </div>

    <div class="card">
        <h2>üöÄ Vypsat Nov√Ω Z√°pas</h2>
        <label>Dom√°c√≠ t√Ωm:</label>
        <input list="statyList" id="d" placeholder="T√Ωm A">
        <label>Hostuj√≠c√≠ t√Ωm:</label>
        <input list="statyList" id="h" placeholder="T√Ωm B">
        <label>Konec s√°zen√≠ (Deadline):</label>
        <input type="datetime-local" id="dl">
        <button class="btn btn-green" onclick="addM()">Uve≈ôejnit Z√°pas</button>
    </div>

    <div class="card">
        <h2>üìä Aktivn√≠ Z√°pasy</h2>
        <div id="adminMatches">Naƒç√≠t√°m...</div>
    </div>
</div>

<div id="modalOverlay" class="modal-overlay"></div>
<div id="evalModal">
    <h3>üõ†Ô∏è Kontrola (Z√°kladn√≠ doba)</h3>
    <p style="font-size: 0.8em; color: gray;">Uprav v√Ωsledek a st≈ôelce p≈ôed vyplacen√≠m.</p>
    
    <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin: 20px 0;">
        <input type="number" id="finalD" style="width:70px; text-align:center; font-size:1.5em;">
        <span style="font-size:1.5em; font-weight:bold;">:</span>
        <input type="number" id="finalH" style="width:70px; text-align:center; font-size:1.5em;">
    </div>

    <label>St≈ôelci v 60. minutƒõ:</label>
    <div id="finalStrelci" class="tag-container"></div>
    
    <div style="display:flex; gap:10px; margin-top:15px;">
        <input type="text" id="addStrelecInput" placeholder="P≈ôidat jm√©no..." style="margin:0;">
        <button class="btn btn-blue" style="width:auto; margin:0;" onclick="manualAddStrelec()">+</button>
    </div>

    <div style="display:flex; gap:10px; margin-top:25px;">
        <button class="btn btn-red" onclick="closeEvalModal()">ZRU≈†IT</button>
        <button class="btn btn-green" id="confirmEvalBtn">POTVRDIT A VYPLATIT</button>
    </div>
</div>

<datalist id="statyList"></datalist>

<script>
    const firebaseConfig = { apiKey: "AIzaSyC-NCdmsgA42FxnopKm92m1y5gUGw_z_uE", authDomain: "nadeje-208bd.firebaseapp.com", databaseURL: "https://nadeje-208bd-default-rtdb.europe-west1.firebasedatabase.app", projectId: "nadeje-208bd", storageBucket: "nadeje-208bd.firebasestorage.app", messagingSenderId: "688478977789", appId: "1:688478977789:web:512d1520cf96c9e59cc894" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentEvalMid = null;
    let currentStrelci = [];

    function initAdmin() {
        const l = document.getElementById('statyList');
        if (typeof vsechnyStaty !== 'undefined') vsechnyStaty.forEach(s => { const o = document.createElement('option'); o.value = s.n; l.appendChild(o); });
        db.ref('sazkyData/prevedenyBank').on('value', snap => { document.getElementById('prevBankInput').value = snap.val() || 0; });
    }

    function saveBank() { 
        db.ref('sazkyData/prevedenyBank').set(parseInt(document.getElementById('prevBankInput').value) || 0); 
        alert("P≈ôeveden√Ω bank ulo≈æen!"); 
    }

    function addM() {
        const d = document.getElementById('d').value, h = document.getElementById('h').value, dl = document.getElementById('dl').value;
        if(!d || !h || !dl) return alert("Vypl≈à v≈°e!");
        const kd = vsechnyStaty.find(s => s.n === d)?.c || "un", kh = vsechnyStaty.find(s => s.n === h)?.c || "un";
        db.ref('sazkyData/zapasy').push({ domaci: d, hoste: h, kodD: kd, kodH: kh, deadline: dl }).then(() => {
            alert("Z√°pas vyps√°n!");
            document.getElementById('d').value = ""; document.getElementById('h').value = ""; document.getElementById('dl').value = "";
        });
    }

    // VYKRESLEN√ç Z√ÅPAS≈Æ
    db.ref('sazkyData/zapasy').on('value', snap => {
        const cont = document.getElementById('adminMatches');
        cont.innerHTML = "";
        const data = snap.val();
        if(!data) return cont.innerHTML = "≈Ω√°dn√© z√°pasy.";

        Object.entries(data).forEach(([mid, m]) => {
            const div = document.createElement('div');
            div.className = 'match-item';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>${m.domaci} - ${m.hoste}</strong>
                    <button class="small-btn btn-red" onclick="deleteM('${mid}')">SMAZAT Z√ÅPAS</button>
                </div>
                <textarea id="raw-${mid}" placeholder="Vlo≈æ text z Livesportu (P≈ôehled)..."></textarea>
                <button class="btn btn-blue" onclick="evalM('${mid}')">VYHODNOTIT Z√ÅPAS</button>
                <div id="bets-${mid}" style="margin-top:15px;"></div>
            `;
            cont.appendChild(div);

            if(m.sazky) {
                Object.entries(m.sazky).forEach(([sid, s]) => {
                    const row = document.createElement('div');
                    row.className = 'bet-admin-row';
                    row.innerHTML = `
                        <span>${s.stav || "‚è≥"} <b>${s.jmeno}</b> (${s.skore} - ${s.strelec})</span>
                        <div>
                            <button class="small-btn btn-green" onclick="markPaid('${mid}','${sid}')">ZAPLACENO</button>
                            <button class="small-btn btn-red" onclick="deleteBet('${mid}','${sid}')">SMAZAT</button>
                        </div>`;
                    document.getElementById(`bets-${mid}`).appendChild(row);
                });
            }
        });
    });

    // PARSER S MOD√ÅLEM
    function evalM(mid) {
        currentEvalMid = mid;
        const raw = document.getElementById(`raw-${mid}`).value;
        if(!raw) return alert("Vlo≈æ text z Livesportu!");

        // Usekneme text p≈ôi prodlou≈æen√≠
        let cleanText = raw.split(/PRODLOU≈ΩEN√ç|PENALTY|N√ÅJEZDY/i)[0];
        
        // Najdeme sk√≥re
        const scoreMatches = cleanText.match(/(\d+)\s*-\s*(\d+)/g);
        let d = 0, h = 0;
        if (scoreMatches) {
            const last = scoreMatches[scoreMatches.length - 1].replace(/\s+/g, '').split('-');
            d = last[0]; h = last[1];
        }

        // Najdeme st≈ôelce
        currentStrelci = [];
        cleanText.split('\n').forEach(r => {
            const t = r.trim();
            if (t && !t.includes('-') && !t.includes(':') && !t.includes('(') && !t.includes('T≈òETINA') && t.length > 3) {
                currentStrelci.push(t.split('+')[0].trim());
            }
        });

        document.getElementById('finalD').value = d;
        document.getElementById('finalH').value = h;
        renderStrelciTags();
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('evalModal').style.display = 'block';

        document.getElementById('confirmEvalBtn').onclick = () => finishEval(mid);
    }

    function renderStrelciTags() {
        const cont = document.getElementById('finalStrelci');
        cont.innerHTML = "";
        currentStrelci.forEach((s, i) => {
            const t = document.createElement('div');
            t.className = 'tag';
            t.innerHTML = `${s} <span onclick="removeStrelec(${i})">√ó</span>`;
            cont.appendChild(t);
        });
    }

    function removeStrelec(i) { currentStrelci.splice(i,1); renderStrelciTags(); }
    function manualAddStrelec() { 
        const v = document.getElementById('addStrelecInput').value; 
        if(v) { currentStrelci.push(v); renderStrelciTags(); document.getElementById('addStrelecInput').value=""; } 
    }
    function closeEvalModal() { 
        document.getElementById('modalOverlay').style.display='none'; 
        document.getElementById('evalModal').style.display='none'; 
    }

    // FIN√ÅLN√ç V√ùPOƒåET V√ùHER
    function finishEval(mid) {
        const konecneSkore = `${document.getElementById('finalD').value}:${document.getElementById('finalH').value}`;
        const fStrelciLower = currentStrelci.map(s => s.toLowerCase());

        db.ref(`sazkyData/zapasy/${mid}`).once('value', snap => {
            const z = snap.val();
            const sazky = Object.entries(z.sazky || {});
            const mBank = sazky.length * 20;

            let lideSeSkore = sazky.filter(([sid, s]) => s.skore.replace(/\s+/g,'') === konecneSkore);
            let vyherciSeStrelcem = lideSeSkore.filter(([sid, s]) => {
                const tip = s.strelec.toLowerCase().trim();
                return fStrelciLower.some(real => real.includes(tip) || tip.includes(real));
            });

            let vyherci = vyherciSeStrelcem.length > 0 ? vyherciSeStrelcem : lideSeSkore;

            db.ref('sazkyData/prevedenyBank').once('value', bSnap => {
                const pBank = bSnap.val() || 0;
                const cVyhra = mBank + pBank;

                if(vyherci.length > 0) {
                    const naHlavu = Math.floor(cVyhra / vyherci.length);
                    vyherci.forEach(([sid, s]) => {
                        db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("üèÜ V√ùHRA");
                        // Z√°pis do statistik
                        db.ref(`sazkyData/stats/${s.jmeno}`).transaction(c => {
                            c = c || { vyhry: 0, trefeneSkore: 0, trefeniStrelci: 0 };
                            c.vyhry += naHlavu; c.trefeneSkore += 1;
                            if(vyherciSeStrelcem.length > 0) c.trefeniStrelci += 1;
                            return c;
                        });
                    });
                    db.ref('sazkyData/prevedenyBank').set(0);
                    alert(`üèÜ HOTOVO! V√Ωherci: ${vyherci.map(v=>v[1].jmeno).join(', ')} (ka≈æd√Ω ${naHlavu} Kƒç)`);
                } else {
                    db.ref('sazkyData/prevedenyBank').set(pBank + mBank);
                    alert(`‚ùå Nikdo netrefil. Bank ${mBank} Kƒç se p≈ôev√°d√≠ do p≈ô√≠≈°tƒõ.`);
                    sazky.forEach(([sid, s]) => db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("‚ùå"));
                }
                closeEvalModal();
            });
        });
    }

    function markPaid(mid, sid) { db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("‚úÖ"); }
    function deleteBet(mid, sid) { if(confirm("Smazat tuto s√°zku?")) db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}`).remove(); }
    function deleteM(mid) { if(confirm("Smazat cel√Ω z√°pas?")) db.ref(`sazkyData/zapasy/${mid}`).remove(); }
</script>
</body>
</html>
