<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin v4.9 - KANCEL√Å≈ò NADƒöJE</title>
    
    <script src="stats.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --blue: #3182ce; 
            --green: #38a169; 
            --red: #e53e3e; 
            --bg: #f0f4f8; 
            --text: #2d3748;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); padding: 20px; color: var(--text); margin: 0; 
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; }
        .btn-back { display: inline-block; padding: 12px 24px; background: white; color: #4a5568; text-decoration: none; border-radius: 12px; font-weight: bold; border: 1px solid #cbd5e0; margin-bottom: 25px; transition: 0.3s; }
        .btn-back:hover { background: #edf2f7; transform: translateX(-3px); }

        .card { background: white; padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: var(--card-shadow); border: 1px solid #e2e8f0; }
        h2 { margin: 0 0 20px 0; border-bottom: 2px solid #edf2f7; padding-bottom: 12px; font-size: 1.5em; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.85em; color: #718096; text-transform: uppercase; }
        input, textarea { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #cbd5e0; border-radius: 10px; box-sizing: border-box; font-size: 1em; font-family: inherit; }

        .btn { padding: 15px; border: none; border-radius: 12px; color: white; cursor: pointer; width: 100%; font-weight: bold; text-transform: uppercase; margin-top: 10px; transition: 0.3s; text-align: center; }
        .btn-blue { background: var(--blue); }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        #statusMsg { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--green); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 9999; }
        .match-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 25px; border-radius: 18px; margin-top: 25px; }
        .bets-container { margin-top: 20px; border-top: 2px dashed #edf2f7; padding-top: 15px; }
        .bet-admin-row { background: white; padding: 12px 18px; border-radius: 12px; margin-top: 10px; border: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center; }
        
        .small-btn { padding: 8px 14px; border-radius: 8px; font-size: 0.75em; border: none; color: white; cursor: pointer; font-weight: bold; margin-left: 6px; }
        .check-ok { color: var(--green); font-weight: bold; margin-left: 10px; font-size: 0.8em; }
        .check-fail { color: var(--red); font-weight: bold; margin-left: 10px; font-size: 0.8em; }
        .win-amount { color: #f1c40f; background: #000; padding: 2px 8px; border-radius: 6px; font-size: 0.85em; margin-left: 10px; }

        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 550px; background: white; border-radius: 25px; box-shadow: 0 0 80px rgba(0,0,0,0.6); display: none; z-index: 3000; padding: 35px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 2999; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 20px 0; background: #f1f5f9; padding: 10px; border-radius: 12px; }
        .tag { background: white; padding: 6px 12px; border-radius: 15px; font-size: 0.85em; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 8px; }
        .tag b { cursor: pointer; color: var(--red); }
        textarea { height: 80px; resize: vertical; }
    </style>
</head>
<body onload="initAdmin()">

<div id="statusMsg">Z√ÅPAS BYL PUBLIKOV√ÅN! ‚úÖ</div>

<div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
        <img src="IMG_8429.png" style="max-width: 200px; border-radius: 20px;">
    </div>
    <a href="index.html" class="btn-back">‚Üê ZPƒöT NA WEB</a>
    <h1 style="text-align: center;">‚öôÔ∏è Administrace v4.9</h1>

    <div class="card">
        <h2>üí∞ Spr√°va banku</h2>
        <label>Z≈Østatek z minul√Ωch kol (Kƒç):</label>
        <input type="number" id="prevBankInput" placeholder="0">
        <button class="btn btn-blue" onclick="saveBank()">Ulo≈æit bank</button>
        <button class="btn btn-red" style="margin-top:20px; font-size:0.8em" onclick="clearStats()">VYNULOVAT ≈ΩEB≈ò√çƒåKY (STATISTIKY)</button>
    </div>

    <div class="card">
        <h2>üöÄ Vypsat nov√Ω z√°pas</h2>
        <div style="display:flex; gap:15px;">
            <div style="flex:1;"><label>Dom√°c√≠:</label><input list="statyList" id="d" placeholder="Dom√°c√≠ t√Ωm"></div>
            <div style="flex:1;"><label>Host√©:</label><input list="statyList" id="h" placeholder="Hostuj√≠c√≠ t√Ωm"></div>
        </div>
        <label>Uz√°vƒõrka (Deadline):</label>
        <input type="datetime-local" id="dl">
        <button id="pubBtn" class="btn btn-green" onclick="addM()">Uve≈ôejnit na webu</button>
    </div>

    <div class="card">
        <h2>üìä Aktivn√≠ z√°pasy</h2>
        <div id="activeMatches">Naƒç√≠t√°m...</div>
    </div>

    <div class="history-section">
        <h2>üìú Historie (Vyhodnoceno)</h2>
        <div id="historyMatches">Zat√≠m ≈æ√°dn√° historie.</div>
    </div>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

<div id="evalModal" class="modal">
    <h3 style="text-align:center">üõ†Ô∏è Vyhodnocen√≠ z√°pasu</h3>
    <div style="display:flex; justify-content:center; gap:15px; margin: 25px 0;">
        <input type="number" id="finalD" style="width:75px; text-align:center; font-size:1.8em; border:2px solid var(--blue); border-radius:10px;">
        <span style="font-size:1.8em; font-weight:bold;">:</span>
        <input type="number" id="finalH" style="width:75px; text-align:center; font-size:1.8em; border:2px solid var(--blue); border-radius:10px;">
    </div>
    <label>St≈ôelci v z√°kladn√≠ hrac√≠ dobƒõ:</label>
    <div id="finalStrelci" class="tag-container"></div>
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <input type="text" id="addStrelecInput" placeholder="Jm√©no st≈ôelce..." style="margin:0;">
        <button class="btn btn-blue" style="width:auto; margin:0; padding:0 20px;" onclick="manualAddStrelec()">+</button>
    </div>
    <button class="btn btn-green" id="confirmEvalBtn">VYPLATIT A P≈òESUNOUT</button>
    <button class="btn" style="background:gray; margin-top:10px;" onclick="closeAllModals()">ZRU≈†IT</button>
</div>

<div id="editBetModal" class="modal">
    <h3 style="text-align:center">‚úèÔ∏è Upravit s√°zku</h3>
    <label>Jm√©no s√°zka≈ôe:</label>
    <input type="text" id="editName">
    <label>Tip (Sk√≥re):</label>
    <input type="text" id="editScore" placeholder="nap≈ô. 2:1">
    <label>St≈ôelec:</label>
    <input type="text" id="editStriker">
    <button class="btn btn-blue" id="confirmEditBtn">ULO≈ΩIT ZMƒöNY</button>
    <button class="btn" style="background:gray; margin-top:10px;" onclick="closeAllModals()">ZRU≈†IT</button>
</div>

<datalist id="statyList"></datalist>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyC-NCdmsgA42FxnopKm92m1y5gUGw_z_uE", 
        authDomain: "nadeje-208bd.firebaseapp.com", 
        databaseURL: "https://nadeje-208bd-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "nadeje-208bd", 
        storageBucket: "nadeje-208bd.firebasestorage.app", 
        messagingSenderId: "688478977789", 
        appId: "1:688478977789:web:512d1520cf96c9e59cc894" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentStrelci = [], openMatches = {};

    function checkAuth() {
        if (!sessionStorage.getItem('adminTime') || (Date.now() - sessionStorage.getItem('adminTime') > 300000)) {
            const h = prompt("Heslo:");
            if (h === "heslo123") sessionStorage.setItem('adminTime', Date.now());
            else window.location.href="index.html";
        }
    }

    function initAdmin() {
        checkAuth();
        const dl = document.getElementById('statyList');
        if (typeof vsechnyStaty !== 'undefined') {
            vsechnyStaty.forEach(s => {
                const o = document.createElement('option');
                o.value = s.n;
                dl.appendChild(o);
            });
        }
        db.ref('sazkyData/prevedenyBank').on('value', snap => {
            document.getElementById('prevBankInput').value = snap.val() || 0;
        });
    }

    function saveBank() {
        checkAuth();
        db.ref('sazkyData/prevedenyBank').set(parseInt(document.getElementById('prevBankInput').value) || 0).then(() => alert("Bank ulo≈æen."));
    }
    
    function clearStats() {
        checkAuth();
        if(confirm("OPRAVDU smazat statistiky v≈°ech hr√°ƒç≈Ø?")) {
            db.ref('sazkyData/stats').remove().then(() => alert("Statistiky vynulov√°ny."));
        }
    }

    function addM() {
        checkAuth();
        const d = document.getElementById('d').value, h = document.getElementById('h').value, dl = document.getElementById('dl').value;
        if(!d || !h || !dl) return alert("Vypl≈à √∫daje!");
        const kd = vsechnyStaty.find(s=>s.n===d)?.c||"un", kh = vsechnyStaty.find(s=>s.n===h)?.c||"un";
        db.ref('sazkyData/zapasy').push({ domaci: d, hoste: h, kodD: kd, kodH: kh, deadline: dl, status: "aktivni" }).then(() => {
            const msg = document.getElementById('statusMsg');
            msg.innerText = "Z√ÅPAS BYL PUBLIKOV√ÅN! ‚úÖ";
            msg.style.background = "var(--green)";
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 3000);
            document.getElementById('d').value = ""; document.getElementById('h').value = "";
        });
    }

    db.ref('sazkyData/zapasy').on('value', snap => {
        const aC = document.getElementById('activeMatches'), hC = document.getElementById('historyMatches');
        aC.innerHTML = ""; hC.innerHTML = "";
        const data = snap.val(); if(!data) return;

        Object.entries(data).forEach(([mid, m]) => {
            const div = document.createElement('div'); div.className = 'match-item';
            const isVisible = openMatches[mid] ? "block" : "none";
            
            let betsHtml = "";
            if(m.sazky) {
                Object.entries(m.sazky).forEach(([sid, s]) => {
                    let resInfo = ""; 
                    if(m.status === "vyhodnoceno") {
                        const skParts = s.skore.split(':');
                        const resParts = m.vysledek.split(':');
                        const skOk = (parseInt(skParts[0]) === parseInt(resParts[0])) && (parseInt(skParts[1]) === parseInt(resParts[1]));
                        
                        if(s.stav === "üèÜ") resInfo = `<span class="win-amount">üèÜ VYPLATIT: ${s.vyhraKc || 0} Kƒç</span>`;
                        else if(skOk) resInfo = `<span class="check-ok">‚úÖ TREFENO</span>`;
                        else resInfo = `<span class="check-fail">‚ùå</span>`;
                    }
                    betsHtml += `
                        <div class="bet-admin-row">
                            <div style="display:flex; flex-direction:column;">
                                <span>${s.stav||"‚è≥"} <b>${s.jmeno}</b></span>
                                <span style="font-size:0.85em; color:#4a5568;">Tip: <b>${s.skore}</b> | St≈ôelec: <b>${s.strelec}</b></span>
                            </div>
                            <div style="display:flex; align-items:center;">
                                ${resInfo}
                                <button class="small-btn btn-blue" onclick="openEditBetModal('${mid}','${sid}',${JSON.stringify(s).replace(/"/g, '&quot;')})">‚úèÔ∏è</button>
                                <button class="small-btn btn-green" onclick="markPaid('${mid}','${sid}')">Kƒå</button>
                                <button class="small-btn btn-red" onclick="deleteBet('${mid}','${sid}')">√ó</button>
                            </div>
                        </div>`;
                });
            }

            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <strong style="font-size:1.1em;">${m.domaci} - ${m.hoste}</strong>
                    ${m.vysledek ? `<b style="background:var(--blue);color:white;padding:4px 12px;border-radius:10px">${m.vysledek}</b>` : ''}
                </div>
                <textarea id="raw-${mid}" placeholder="Vlo≈æ text z Livesportu..."></textarea>
                <div style="display:flex;gap:10px;margin-top:10px">
                    <button class="btn btn-blue" style="flex:2; margin:0" onclick="evalM('${mid}')">VYHODNOTIT</button>
                    <button class="btn" style="flex:1; margin:0; background:gray" onclick="toggleBets('${mid}')" id="btn-${mid}">${openMatches[mid]?'SKR√ùT':'S√ÅZKY'} (${m.sazky?Object.keys(m.sazky).length:0})</button>
                </div>
                <div id="bets-${mid}" class="bets-container" style="display:${isVisible}">${betsHtml || '<p style="text-align:center;opacity:0.5">≈Ω√°dn√© s√°zky</p>'}</div>
                <button class="btn btn-red" style="font-size:0.7em; margin-top:15px; padding:8px" onclick="deleteM('${mid}')">SMAZAT Z√ÅPAS</button>`;
            
            if(m.status === "vyhodnoceno") hC.appendChild(div); else aC.appendChild(div);
        });
    });

    function toggleBets(mid) {
        openMatches[mid] = !openMatches[mid];
        const el = document.getElementById(`bets-${mid}`);
        const btn = document.getElementById(`btn-${mid}`);
        if(el) el.style.display = openMatches[mid] ? "block" : "none";
        if(btn) btn.innerText = openMatches[mid] ? "SKR√ùT" : `S√ÅZKY (${btn.innerText.match(/\d+/)[0]})`;
    }

    function openEditBetModal(mid, sid, s) {
        checkAuth();
        document.getElementById('editName').value = s.jmeno;
        document.getElementById('editScore').value = s.skore;
        document.getElementById('editStriker').value = s.strelec;
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('editBetModal').style.display = 'block';
        document.getElementById('confirmEditBtn').onclick = () => {
            const upName = document.getElementById('editName').value;
            const upScore = document.getElementById('editScore').value;
            const upStriker = document.getElementById('editStriker').value;
            db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}`).update({
                jmeno: upName,
                skore: upScore,
                strelec: upStriker
            }).then(() => {
                closeAllModals();
                alert("S√°zka upravena!");
            });
        };
    }

    function evalM(mid) {
        checkAuth();
        const raw = document.getElementById(`raw-${mid}`).value; if(!raw) return alert("Vlo≈æ text!");
        
        // Naƒçten√≠ st√°vaj√≠c√≠ch st≈ôelc≈Ø, pokud u z√°pasu jsou (OPRAVA POZTR√ÅCEN√ùCH ST≈òELC≈Æ)
        db.ref(`sazkyData/zapasy/${mid}`).once('value', snap => {
            const m = snap.val();
            currentStrelci = m.strelciZapasu ? [...m.strelciZapasu] : [];

            let clean = raw.split(/PRODLOU≈ΩEN√ç|PENALTY|N√ÅJEZDY|OVERTIME/i)[0];
            const sc = clean.match(/(\d+)\s*[:|-]\s*(\d+)/g);
            let d=0, h=0; if(sc){ const l=sc[sc.length-1].replace(/\s/g,'').replace('-',':').split(':'); d=parseInt(l[0]); h=parseInt(l[1]); }
            
            const zak = ["t≈ôetina", "poloƒças", "konec", "p≈ôest√°vka", "vylouƒçen√≠", "minuta", "karta", "st≈ô√≠d√°n√≠", "rozhodƒç√≠", "asistence", "vlastn√≠", "penalta"];
            clean.split('\n').forEach(line => {
                const t = line.trim();
                if (t.match(/^[\d+]+['.]/)) {
                    let n = t.replace(/^[\d+]+['.]\s*/, '').split('(')[0].split(',')[0].replace(/[0-9]/g, '').replace(/[:|-]/g, '').trim();
                    if (n.length > 3 && !zak.some(z => n.toLowerCase().includes(z)) && !currentStrelci.includes(n)) currentStrelci.push(n);
                }
            });

            document.getElementById('finalD').value = d; document.getElementById('finalH').value = h;
            renderTags();
            document.getElementById('modalOverlay').style.display='block'; document.getElementById('evalModal').style.display='block';
            document.getElementById('confirmEvalBtn').onclick = () => finishEval(mid);
        });
    }

    function renderTags() {
        const c = document.getElementById('finalStrelci'); c.innerHTML = "";
        currentStrelci.forEach((s, i) => c.innerHTML += `<div class="tag">${s} <b onclick="currentStrelci.splice(${i},1);renderTags()" style="cursor:pointer;color:red">√ó</b></div>`);
    }

    function manualAddStrelec() {
        const v = document.getElementById('addStrelecInput').value;
        if(v) { currentStrelci.push(v); renderTags(); document.getElementById('addStrelecInput').value = ""; }
    }

    function finishEval(mid) {
        const finalD = parseInt(document.getElementById('finalD').value);
        const finalH = parseInt(document.getElementById('finalH').value);
        const fs = `${finalD}:${finalH}`;
        const rawStrelci = [...currentStrelci]; 
        const fst = rawStrelci.map(s => s.toLowerCase().trim());

        db.ref(`sazkyData/zapasy/${mid}`).once('value', snap => {
            const z = snap.val(), sazkyEntries = Object.entries(z.sazky || {});
            
            // 1. Najdeme ty, co trefili P≈òESN√â SK√ìRE
            let winS = sazkyEntries.filter(([sid, s]) => {
                const parts = s.skore.split(':');
                return parseInt(parts[0]) === finalD && parseInt(parts[1]) === finalH;
            });
            
            // 2. Najdeme ty, co k tomu trefili i ST≈òELCE
            let winB = winS.filter(([sid, s]) => {
                const pStr = s.strelec.toLowerCase().trim();
                return fst.some(r => r.includes(pStr) || pStr.includes(r));
            });

            // 3. Urƒç√≠me skuteƒçn√© v√≠tƒõze banku (Tie-breaker st≈ôelec)
            let vyherciBanku = winB.length > 0 ? winB : winS;
            const idVyhercuBanku = vyherciBanku.map(item => item[0]);

            db.ref('sazkyData/prevedenyBank').once('value', bSnap => {
                const totalAmount = (sazkyEntries.length * 20) + (parseInt(bSnap.val()) || 0);
                
                // Reset stav≈Ø
                sazkyEntries.forEach(([sid, s]) => {
                    db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("‚ùå");
                    db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/vyhraKc`).set(0);
                });

                if(vyherciBanku.length > 0) {
                    const share = Math.floor(totalAmount / vyherciBanku.length);
                    
                    // V√Ωherci s bankem (üèÜ)
                    vyherciBanku.forEach(([sid, s]) => {
                        db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("üèÜ");
                        db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/vyhraKc`).set(share);
                        db.ref(`sazkyData/stats/${s.jmeno}/vyhry`).transaction(curr => (curr || 0) + share);
                    });

                    // Ostatn√≠, co trefili jen sk√≥re (‚úÖ)
                    winS.forEach(([sid, s]) => {
                        if(!idVyhercuBanku.includes(sid)) db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("‚úÖ");
                    });

                    db.ref('sazkyData/prevedenyBank').set(0);
                } else {
                    db.ref('sazkyData/prevedenyBank').set(totalAmount);
                }
                
                // P≈ôiƒçten√≠ bod≈Ø do statistik pro v≈°echny
                sazkyEntries.forEach(([sid, s]) => {
                    const parts = s.skore.split(':');
                    const hitsScore = parseInt(parts[0]) === finalD && parseInt(parts[1]) === finalH;
                    const pStr = s.strelec.toLowerCase().trim();
                    const hitsStriker = fst.some(r => r.includes(pStr) || pStr.includes(r));

                    if(hitsScore) db.ref(`sazkyData/stats/${s.jmeno}/trefeneSkore`).transaction(c => (c || 0) + 1);
                    if(hitsStriker) db.ref(`sazkyData/stats/${s.jmeno}/trefeniStrelci`).transaction(c => (c || 0) + 1);
                });

                db.ref(`sazkyData/zapasy/${mid}/status`).set("vyhodnoceno");
                db.ref(`sazkyData/zapasy/${mid}/vysledek`).set(fs);
                db.ref(`sazkyData/zapasy/${mid}/strelciZapasu`).set(rawStrelci); 
                
                document.getElementById(`raw-${mid}`).value = "";
                const msg = document.getElementById('statusMsg');
                msg.innerText = "Z√ÅPAS VYHODNOCEN A V√ùHRY ROZDƒöLENY! üèÜ";
                msg.style.background = "var(--blue)";
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 4000);

                closeAllModals();
            });
        });
    }

    function closeAllModals() { 
        document.getElementById('modalOverlay').style.display='none'; 
        document.getElementById('evalModal').style.display='none'; 
        document.getElementById('editBetModal').style.display='none'; 
    }
    
    function markPaid(mid, sid) { db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}/stav`).set("‚úÖ"); }
    function deleteBet(mid, sid) { if(confirm("Smazat?")) db.ref(`sazkyData/zapasy/${mid}/sazky/${sid}`).remove(); }
    function deleteM(mid) { if(confirm("Smazat?")) db.ref(`sazkyData/zapasy/${mid}`).remove(); }
</script>
</body>
</html>
